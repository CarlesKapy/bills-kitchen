
# global Vagrant configuration
Vagrant.configure("2") do |config|

  # workaround for mitchellh/vagrant#4073
  ENV["VAGRANT_DETECTED_OS"] = ENV["VAGRANT_DETECTED_OS"].to_s + " cygwin"

  # enable cachier globally
  if Vagrant.has_plugin?("vagrant-cachier")
    config.cache.scope = :box

    # cache bussers, but only if we detect a test-kitchen run
    # see https://github.com/tknerr/bills-kitchen/pull/78
    if Dir.pwd.include? ".kitchen/kitchen-vagrant/"

      config.cache.enable :generic, {
        # for test-kitchen =< 1.3
        "busser-gemcache" => { cache_dir: "/tmp/busser/gems/cache" },
        # for test-kitchen >= 1.4
        "verifier-gemcache" => { cache_dir: "/tmp/verifier/gems/cache" }
      }

      # fix permissions 
      # see https://github.com/mitchellh/vagrant/issues/2257
      # see https://github.com/test-kitchen/test-kitchen/issues/671
      config.vm.provision "shell", inline: <<-EOF
        chown -R vagrant:vagrant /tmp/busser
        chown -R vagrant:vagrant /tmp/verifier
      EOF
    end
  end
end
